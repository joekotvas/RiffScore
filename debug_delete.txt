
> pianoriffs.studio@0.1.0 test
> jest src/components/SheetMusicEditor/__tests__/Interaction.test.tsx

  console.log
    [04:48:40.440] [INFO] COMMAND: ADD_NOTE AddNoteCommand {
      measureIndex: 0,
      note: { id: 1765342120441, pitch: 'C4', accidental: null, tied: false },
      duration: 'quarter',
      isDotted: false,
      index: undefined,
      eventId: '1765342120440',
      staffIndex: 0,
      type: 'ADD_NOTE'
    }

      at DebugLogger.log (src/components/SheetMusicEditor/utils/debug.ts:45:17)

  console.log
    [04:48:40.551] [INFO] COMMAND: ADD_NOTE AddNoteCommand {
      measureIndex: 0,
      note: { id: 1765342120552, pitch: 'C4', accidental: null, tied: false },
      duration: 'quarter',
      isDotted: false,
      index: undefined,
      eventId: '1765342120551',
      staffIndex: 0,
      type: 'ADD_NOTE'
    }

      at DebugLogger.log (src/components/SheetMusicEditor/utils/debug.ts:45:17)

  console.log
    [04:48:40.575] [INFO] COMMAND: ADD_NOTE AddNoteCommand {
      measureIndex: 0,
      note: { id: 1765342120576, pitch: 'E4', accidental: null, tied: false },
      duration: 'quarter',
      isDotted: false,
      index: undefined,
      eventId: '1765342120575',
      staffIndex: 0,
      type: 'ADD_NOTE'
    }

      at DebugLogger.log (src/components/SheetMusicEditor/utils/debug.ts:45:17)

  console.log
    [04:48:40.597] [INFO] COMMAND: ADD_NOTE AddNoteCommand {
      measureIndex: 0,
      note: { id: 1765342120598, pitch: 'D4', accidental: null, tied: false },
      duration: 'quarter',
      isDotted: false,
      index: undefined,
      eventId: '1765342120597',
      staffIndex: 0,
      type: 'ADD_NOTE'
    }

      at DebugLogger.log (src/components/SheetMusicEditor/utils/debug.ts:45:17)

  console.log
    [04:48:40.642] [INFO] COMMAND: ADD_NOTE AddNoteCommand {
      measureIndex: 0,
      note: { id: 1765342120643, pitch: 'C4', accidental: null, tied: false },
      duration: 'quarter',
      isDotted: false,
      index: undefined,
      eventId: '1765342120642',
      staffIndex: 0,
      type: 'ADD_NOTE'
    }

      at DebugLogger.log (src/components/SheetMusicEditor/utils/debug.ts:45:17)

  console.error
    Error: Uncaught [TypeError: Cannot read properties of undefined (reading 'toLowerCase')]
        at reportException (/Users/josephkotvas/Sites/Riffs/riffeasy/pianoriffs.studio/node_modules/jsdom/lib/jsdom/living/helpers/runtime-script-errors.js:66:24)
        at innerInvokeEventListeners (/Users/josephkotvas/Sites/Riffs/riffeasy/pianoriffs.studio/node_modules/jsdom/lib/jsdom/living/events/EventTarget-impl.js:353:9)
        at invokeEventListeners (/Users/josephkotvas/Sites/Riffs/riffeasy/pianoriffs.studio/node_modules/jsdom/lib/jsdom/living/events/EventTarget-impl.js:286:3)
        at EventTargetImpl._dispatch (/Users/josephkotvas/Sites/Riffs/riffeasy/pianoriffs.studio/node_modules/jsdom/lib/jsdom/living/events/EventTarget-impl.js:233:9)
        at EventTargetImpl.dispatchEvent (/Users/josephkotvas/Sites/Riffs/riffeasy/pianoriffs.studio/node_modules/jsdom/lib/jsdom/living/events/EventTarget-impl.js:104:17)
        at dispatchEvent (/Users/josephkotvas/Sites/Riffs/riffeasy/pianoriffs.studio/node_modules/jsdom/lib/jsdom/living/generated/EventTarget.js:241:34)
        at /Users/josephkotvas/Sites/Riffs/riffeasy/pianoriffs.studio/node_modules/@testing-library/dom/dist/events.js:19:20
        at /Users/josephkotvas/Sites/Riffs/riffeasy/pianoriffs.studio/node_modules/@testing-library/react/dist/pure.js:108:16
        at /Users/josephkotvas/Sites/Riffs/riffeasy/pianoriffs.studio/node_modules/@testing-library/react/dist/act-compat.js:48:24
        at process.env.NODE_ENV.exports.act (/Users/josephkotvas/Sites/Riffs/riffeasy/pianoriffs.studio/node_modules/react/cjs/react.development.js:814:22)
        at /Users/josephkotvas/Sites/Riffs/riffeasy/pianoriffs.studio/node_modules/@testing-library/react/dist/act-compat.js:47:25
        at Object.eventWrapper (/Users/josephkotvas/Sites/Riffs/riffeasy/pianoriffs.studio/node_modules/@testing-library/react/dist/pure.js:107:28)
        at fireEvent (/Users/josephkotvas/Sites/Riffs/riffeasy/pianoriffs.studio/node_modules/@testing-library/dom/dist/events.js:12:35)
        at Function.fireEvent.<computed> [as keyDown] (/Users/josephkotvas/Sites/Riffs/riffeasy/pianoriffs.studio/node_modules/@testing-library/dom/dist/events.js:110:36)
        at Function.fireEvent.<computed> [as keyDown] (/Users/josephkotvas/Sites/Riffs/riffeasy/pianoriffs.studio/node_modules/@testing-library/react/dist/fire-event.js:15:52)
        at Object.<anonymous> (/Users/josephkotvas/Sites/Riffs/riffeasy/pianoriffs.studio/src/components/SheetMusicEditor/__tests__/Interaction.test.tsx:179:19) {
      detail: TypeError: Cannot read properties of undefined (reading 'toLowerCase')
          at /Users/josephkotvas/Sites/Riffs/riffeasy/pianoriffs.studio/src/components/SheetMusicEditor/hooks/useKeyboardShortcuts.ts:32:42
          at callTheUserObjectsOperation (/Users/josephkotvas/Sites/Riffs/riffeasy/pianoriffs.studio/node_modules/jsdom/lib/jsdom/living/generated/EventListener.js:26:30)
          at innerInvokeEventListeners (/Users/josephkotvas/Sites/Riffs/riffeasy/pianoriffs.studio/node_modules/jsdom/lib/jsdom/living/events/EventTarget-impl.js:350:25)
          at invokeEventListeners (/Users/josephkotvas/Sites/Riffs/riffeasy/pianoriffs.studio/node_modules/jsdom/lib/jsdom/living/events/EventTarget-impl.js:286:3)
          at EventTargetImpl._dispatch (/Users/josephkotvas/Sites/Riffs/riffeasy/pianoriffs.studio/node_modules/jsdom/lib/jsdom/living/events/EventTarget-impl.js:233:9)
          at EventTargetImpl.dispatchEvent (/Users/josephkotvas/Sites/Riffs/riffeasy/pianoriffs.studio/node_modules/jsdom/lib/jsdom/living/events/EventTarget-impl.js:104:17)
          at dispatchEvent (/Users/josephkotvas/Sites/Riffs/riffeasy/pianoriffs.studio/node_modules/jsdom/lib/jsdom/living/generated/EventTarget.js:241:34)
          at /Users/josephkotvas/Sites/Riffs/riffeasy/pianoriffs.studio/node_modules/@testing-library/dom/dist/events.js:19:20
          at /Users/josephkotvas/Sites/Riffs/riffeasy/pianoriffs.studio/node_modules/@testing-library/react/dist/pure.js:108:16
          at /Users/josephkotvas/Sites/Riffs/riffeasy/pianoriffs.studio/node_modules/@testing-library/react/dist/act-compat.js:48:24
          at process.env.NODE_ENV.exports.act (/Users/josephkotvas/Sites/Riffs/riffeasy/pianoriffs.studio/node_modules/react/cjs/react.development.js:814:22)
          at /Users/josephkotvas/Sites/Riffs/riffeasy/pianoriffs.studio/node_modules/@testing-library/react/dist/act-compat.js:47:25
          at Object.eventWrapper (/Users/josephkotvas/Sites/Riffs/riffeasy/pianoriffs.studio/node_modules/@testing-library/react/dist/pure.js:107:28)
          at fireEvent (/Users/josephkotvas/Sites/Riffs/riffeasy/pianoriffs.studio/node_modules/@testing-library/dom/dist/events.js:12:35)
          at Function.fireEvent.<computed> [as keyDown] (/Users/josephkotvas/Sites/Riffs/riffeasy/pianoriffs.studio/node_modules/@testing-library/dom/dist/events.js:110:36)
          at Function.fireEvent.<computed> [as keyDown] (/Users/josephkotvas/Sites/Riffs/riffeasy/pianoriffs.studio/node_modules/@testing-library/react/dist/fire-event.js:15:52)
          at Object.<anonymous> (/Users/josephkotvas/Sites/Riffs/riffeasy/pianoriffs.studio/src/components/SheetMusicEditor/__tests__/Interaction.test.tsx:179:19),
      type: 'unhandled exception'
    }

      177 |
      178 |         // Simulate 'Backspace' or 'Delete' key
    > 179 |         fireEvent.keyDown(window, { key: 'Backspace', code: 'Backspace', keyCode: 8 });
          |                   ^
      180 |
      181 |         // Verify Deletion
      182 |         // The chord group should be gone.

      at VirtualConsole.<anonymous> (node_modules/@jest/environment-jsdom-abstract/build/index.js:87:23)
      at reportException (node_modules/jsdom/lib/jsdom/living/helpers/runtime-script-errors.js:70:28)
      at innerInvokeEventListeners (node_modules/jsdom/lib/jsdom/living/events/EventTarget-impl.js:353:9)
      at invokeEventListeners (node_modules/jsdom/lib/jsdom/living/events/EventTarget-impl.js:286:3)
      at EventTargetImpl._dispatch (node_modules/jsdom/lib/jsdom/living/events/EventTarget-impl.js:233:9)
      at EventTargetImpl.dispatchEvent (node_modules/jsdom/lib/jsdom/living/events/EventTarget-impl.js:104:17)
      at dispatchEvent (node_modules/jsdom/lib/jsdom/living/generated/EventTarget.js:241:34)
      at node_modules/@testing-library/dom/dist/events.js:19:20
      at node_modules/@testing-library/react/dist/pure.js:108:16
      at node_modules/@testing-library/react/dist/act-compat.js:48:24
      at process.env.NODE_ENV.exports.act (node_modules/react/cjs/react.development.js:814:22)
      at node_modules/@testing-library/react/dist/act-compat.js:47:25
      at Object.eventWrapper (node_modules/@testing-library/react/dist/pure.js:107:28)
      at fireEvent (node_modules/@testing-library/dom/dist/events.js:12:35)
      at Function.fireEvent.<computed> [as keyDown] (node_modules/@testing-library/dom/dist/events.js:110:36)
      at Function.fireEvent.<computed> [as keyDown] (node_modules/@testing-library/react/dist/fire-event.js:15:52)
      at Object.<anonymous> (src/components/SheetMusicEditor/__tests__/Interaction.test.tsx:179:19)

FAIL src/components/SheetMusicEditor/__tests__/Interaction.test.tsx
  ScoreEditor Interactions
    ✓ User can add a note by clicking on a measure (298 ms)
    ✓ User can insert a note between existing notes (86 ms)
    ✕ User can delete a selected note (125 ms)

  ● ScoreEditor Interactions › User can delete a selected note

    TypeError: Cannot read properties of undefined (reading 'toLowerCase')

      30 |
      31 |     const handleKeyDown = useCallback((e: any) => {
    > 32 |         const tagName = e.target.tagName.toLowerCase();
         |                                          ^
      33 |         if (tagName === 'input' || tagName === 'textarea') {
      34 |             if (e.key === 'Enter' && isEditingTitle) {
      35 |                 e.preventDefault();

      at src/components/SheetMusicEditor/hooks/useKeyboardShortcuts.ts:32:42
      at callTheUserObjectsOperation (node_modules/jsdom/lib/jsdom/living/generated/EventListener.js:26:30)
      at innerInvokeEventListeners (node_modules/jsdom/lib/jsdom/living/events/EventTarget-impl.js:350:25)
      at invokeEventListeners (node_modules/jsdom/lib/jsdom/living/events/EventTarget-impl.js:286:3)
      at EventTargetImpl._dispatch (node_modules/jsdom/lib/jsdom/living/events/EventTarget-impl.js:233:9)
      at EventTargetImpl.dispatchEvent (node_modules/jsdom/lib/jsdom/living/events/EventTarget-impl.js:104:17)
      at dispatchEvent (node_modules/jsdom/lib/jsdom/living/generated/EventTarget.js:241:34)
      at node_modules/@testing-library/dom/dist/events.js:19:20
      at node_modules/@testing-library/react/dist/pure.js:108:16
      at node_modules/@testing-library/react/dist/act-compat.js:48:24
      at process.env.NODE_ENV.exports.act (node_modules/react/cjs/react.development.js:814:22)
      at node_modules/@testing-library/react/dist/act-compat.js:47:25
      at Object.eventWrapper (node_modules/@testing-library/react/dist/pure.js:107:28)
      at fireEvent (node_modules/@testing-library/dom/dist/events.js:12:35)
      at Function.fireEvent.<computed> [as keyDown] (node_modules/@testing-library/dom/dist/events.js:110:36)
      at Function.fireEvent.<computed> [as keyDown] (node_modules/@testing-library/react/dist/fire-event.js:15:52)
      at Object.<anonymous> (src/components/SheetMusicEditor/__tests__/Interaction.test.tsx:179:19)

  ● ScoreEditor Interactions › User can delete a selected note

    expect(received).toHaveLength(expected)

    Expected length: 0
    Received length: 1
    Received array:  [<g class="chord-group " data-selected="true" data-testid="chord-1765342120642" style="opacity: 1;"><line stroke="#20B2AA" stroke-width="1.5" x1="42" x2="42" y1="130" y2="95" /><g class="note-group-container"><g style="pointer-events: none;"><g class="note-group"><line stroke="#20B2AA" stroke-width="1.5" x1="26" x2="46" y1="130" y2="130" /><ellipse cx="36" cy="130" fill="#20B2AA" rx="6" ry="4" stroke="#20B2AA" stroke-width="2" transform="rotate(-20 36 130)" /></g></g><rect fill="white" fill-opacity="0.01" height="16" style="cursor: crosshair;" width="20" x="26" y="122" /></g></g>]

      189 |         
      190 |         const remainingChords = screen.queryAllByTestId(/^chord-/);
    > 191 |         expect(remainingChords).toHaveLength(0);
          |                                 ^
      192 |     });
      193 | });
      194 |

      at Object.<anonymous> (src/components/SheetMusicEditor/__tests__/Interaction.test.tsx:191:33)

Test Suites: 1 failed, 1 total
Tests:       1 failed, 2 passed, 3 total
Snapshots:   0 total
Time:        2.985 s
Ran all test suites matching src/components/SheetMusicEditor/__tests__/Interaction.test.tsx.
